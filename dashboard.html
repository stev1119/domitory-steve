<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ìˆ™ì‚¬ í†µí•© ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #60a5fa, #34d399, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            color: #cbd5e1;
        }

        .search-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 18px 60px 18px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 10px;
            display: none;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: scale(1.05) rotateY(5deg);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-card h3 {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #cbd5e1;
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .description {
            font-size: 0.9rem;
            opacity: 0.7;
            color: #94a3b8;
        }

        .gender-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .gender-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .gender-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
        }

        .male-section .gender-title {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .female-section .gender-title {
            background: linear-gradient(45deg, #ec4899, #be185d);
            color: white;
        }

        .building-reports {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .building-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }

        .building-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.12);
        }

        .building-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .building-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #60a5fa;
        }

        .floor-reports {
            display: grid;
            gap: 10px;
        }

        .floor-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .floor-card:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .floor-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .floor-name {
            font-weight: 600;
            color: #e2e8f0;
        }

        .manager-name {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .floor-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .floor-stat {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .floor-stat:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .student-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .student-detail-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #60a5fa;
        }

        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .student-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .student-info-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .student-info-card:hover {
            transform: scale(1.02);
            background: rgba(255, 255, 255, 0.15);
        }

        .student-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .student-room {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fbbf24;
        }

        .student-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-normal { background: #10b981; color: white; }
        .status-overnight { background: #3b82f6; color: white; }
        .status-checkout { background: #ef4444; color: white; }
        .status-new { background: #8b5cf6; color: white; }
        .status-move-minus { background: #f59e0b; color: white; }
        .status-move-plus { background: #06b6d4; color: white; }
        .status-late { background: #84cc16; color: white; }

        .student-details {
            display: grid;
            gap: 8px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .detail-value {
            font-size: 0.9rem;
            color: #e2e8f0;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .gender-stats {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .building-reports {
                grid-template-columns: 1fr;
            }

            .student-cards-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 20px;
                padding: 20px;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(45deg, #10b981, #059669);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            color: white;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ê¸°ìˆ™ì‚¬ í†µí•© ëŒ€ì‹œë³´ë“œ</h1>
            <p>Real-time Student Management Dashboard 2026</p>
        </div>

        <!-- í•™ìƒ ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="glass-card search-section">
            <h2 class="section-title">
                <i data-lucide="search"></i>
                í•™ìƒ ê²€ìƒ‰
            </h2>
            <div class="search-container">
                <input type="text" class="search-input" id="student-search" 
                       placeholder="ì´ë¦„, ê¸°ìˆ™ì‚¬ë²ˆí˜¸, ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¢Œì„ë²ˆí˜¸ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”...">
                <i data-lucide="search" class="search-icon"></i>
                <div class="search-results" id="search-results"></div>
            </div>
        </div>

        <!-- ì „ì²´ í˜„í™© ì§‘ê³„ -->
        <div class="glass-card">
            <h2 class="section-title">
                <i data-lucide="bar-chart-3"></i>
                ì „ì²´ í˜„í™© ì§‘ê³„
            </h2>
            <div class="stats-grid" id="total-stats">
                <div class="stat-card" onclick="showStudentDetails('total', 'current')">
                    <h3>ì´ í˜„ì¬ì›</h3>
                    <div class="number" id="total-current">0</div>
                    <div class="description">ì¬ì› ì¤‘ì¸ í•™ìƒ</div>
                </div>
                <div class="stat-card" onclick="showStudentDetails('total', 'overnight')">
                    <h3>ì´ ì™¸ë°•</h3>
                    <div class="number" id="total-overnight">0</div>
                    <div class="description">ì™¸ë°• ì‹ ì²­ í•™ìƒ</div>
                </div>
                <div class="stat-card" onclick="showStudentDetails('total', 'new')">
                    <h3>ì´ ì‹ ê·œ</h3>
                    <div class="number" id="total-new">0</div>
                    <div class="description">ì‹ ê·œ ì…ì†Œ í•™ìƒ</div>
                </div>
                <div class="stat-card" onclick="showStudentDetails('total', 'checkout')">
                    <h3>ì´ í‡´ì†Œ</h3>
                    <div class="number" id="total-checkout">0</div>
                    <div class="description">í‡´ì†Œ ì˜ˆì • í•™ìƒ</div>
                </div>
                <div class="stat-card" onclick="showStudentDetails('total', 'move-minus')">
                    <h3>ì´ ì´ë™-</h3>
                    <div class="number" id="total-move-minus">0</div>
                    <div class="description">ì´ë™ ì¶œë°œ í•™ìƒ</div>
                </div>
                <div class="stat-card" onclick="showStudentDetails('total', 'move-plus')">
                    <h3>ì´ ì´ë™+</h3>
                    <div class="number" id="total-move-plus">0</div>
                    <div class="description">ì´ë™ ë„ì°© í•™ìƒ</div>
                </div>
                <div class="stat-card" onclick="showStudentDetails('total', 'late')">
                    <h3>ì´ ë“±ë¯¸</h3>
                    <div class="number" id="total-late">0</div>
                    <div class="description">ë“±êµ ë¯¸ì²˜ë¦¬ í•™ìƒ</div>
                </div>
                <div class="stat-card" onclick="showStudentDetails('total', 'other')">
                    <h3>ì´ ê¸°íƒ€</h3>
                    <div class="number" id="total-other">0</div>
                    <div class="description">ê¸°íƒ€ ìƒíƒœ í•™ìƒ</div>
                </div>
            </div>
        </div>

        <!-- ì„±ë³„ êµ¬ë¶„ í˜„í™© -->
        <div class="glass-card">
            <h2 class="section-title">
                <i data-lucide="users"></i>
                ì„±ë³„ êµ¬ë¶„ í˜„í™©
            </h2>
            <div class="gender-stats">
                <div class="gender-section male-section">
                    <div class="gender-title">ğŸ‘¨ ë‚¨í•™ìƒ (A, B, C, Fë™)</div>
                    <div class="stats-grid" id="male-stats">
                        <div class="stat-card" onclick="showStudentDetails('male', 'current')">
                            <h3>í˜„ì¬ì›</h3>
                            <div class="number" id="male-current">0</div>
                        </div>
                        <div class="stat-card" onclick="showStudentDetails('male', 'overnight')">
                            <h3>ì™¸ë°•</h3>
                            <div class="number" id="male-overnight">0</div>
                        </div>
                        <div class="stat-card" onclick="showStudentDetails('male', 'new')">
                            <h3>ì‹ ê·œ</h3>
                            <div class="number" id="male-new">0</div>
                        </div>
                        <div class="stat-card" onclick="showStudentDetails('male', 'checkout')">
                            <h3>í‡´ì†Œ</h3>
                            <div class="number" id="male-checkout">0</div>
                        </div>
                    </div>
                </div>
                <div class="gender-section female-section">
                    <div class="gender-title">ğŸ‘© ì—¬í•™ìƒ (D, Eë™)</div>
                    <div class="stats-grid" id="female-stats">
                        <div class="stat-card" onclick="showStudentDetails('female', 'current')">
                            <h3>í˜„ì¬ì›</h3>
                            <div class="number" id="female-current">0</div>
                        </div>
                        <div class="stat-card" onclick="showStudentDetails('female', 'overnight')">
                            <h3>ì™¸ë°•</h3>
                            <div class="number" id="female-overnight">0</div>
                        </div>
                        <div class="stat-card" onclick="showStudentDetails('female', 'new')">
                            <h3>ì‹ ê·œ</h3>
                            <div class="number" id="female-new">0</div>
                        </div>
                        <div class="stat-card" onclick="showStudentDetails('female', 'checkout')">
                            <h3>í‡´ì†Œ</h3>
                            <div class="number" id="female-checkout">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë™ë³„/ì¸µë³„ ë³´ê³  í˜„í™© -->
        <div class="glass-card">
            <h2 class="section-title">
                <i data-lucide="building"></i>
                ë™ë³„/ì¸µë³„ ë³´ê³  í˜„í™©
            </h2>
            <div class="building-reports" id="building-reports">
                <!-- ë™ë³„ í˜„í™©ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- í•™ìƒ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div class="student-detail-modal" id="student-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">í•™ìƒ ìƒì„¸ ì •ë³´</h3>
                <button class="close-btn" onclick="closeModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="student-cards-grid" id="student-cards-container">
                <!-- í•™ìƒ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
    <button class="refresh-btn" onclick="refreshAllData()" title="ë°ì´í„° ìƒˆë¡œê³ ì¹¨">
        <i data-lucide="refresh-cw"></i>
    </button>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let allStudentData = [];
        let reportData = {};
        let searchTimeout;

        // ê¸°ìˆ™ì‚¬ êµ¬ì¡° ì •ì˜ (3ìë¦¬ í˜¸ì‹¤ë²ˆí˜¸)
        const dormitoryStructure = {
            A: { gender: 'male', floors: [1, 2, 3, 4] },
            B: { gender: 'male', floors: [1, 2, 3, 4] },
            C: { gender: 'male', floors: [1, 2, 3, 4] },
            D: { gender: 'female', floors: [1, 2, 3, 4] },
            E: { gender: 'female', floors: [1, 2, 3, 4] },
            F: { gender: 'male', floors: [1, 2, 3, 4] }
        };

        // 3ì¸ì‹¤ ë²”ìœ„ ì •ì˜
        const tripleRoomRanges = {
            A: { start: 188, end: 432 },
            B: { start: 406, end: 468 },
            C: { start: 654, end: 749 },
            D: { start: 884, end: 952 },
            E: { start: 1185, end: 1304 },
            F: { start: 1403, end: 1453 }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            initializeSearch();
            loadAllData();
        });

        // ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
        function initializeSearch() {
            const searchInput = document.getElementById('student-search');
            const searchResults = document.getElementById('search-results');

            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();

                if (query.length < 1) {
                    searchResults.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });

            searchInput.addEventListener('focus', function() {
                if (this.value.trim() && searchResults.children.length > 0) {
                    searchResults.style.display = 'block';
                }
            });

            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        }

        // ì‹¤ì‹œê°„ ê²€ìƒ‰ ìˆ˜í–‰
        function performSearch(query) {
            const searchResults = document.getElementById('search-results');
            const results = searchStudents(query);

            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                searchResults.innerHTML = results.map(student => `
                    <div class="search-result-item" onclick="showStudentCard('${student.id}')">
                        <div style="font-weight: 600; color: #60a5fa;">${student.roomNumber} - ${student.name}</div>
                        <div style="font-size: 0.9rem; color: #94a3b8; margin-top: 5px;">
                            ìƒíƒœ: ${student.status} | ì„±ë³„: ${student.gender} | ì—°ë½ì²˜: ${student.studentPhone}
                        </div>
                    </div>
                `).join('');
            }

            searchResults.style.display = 'block';
        }

        // í•™ìƒ ê²€ìƒ‰ ë¡œì§
        function searchStudents(query) {
            const normalizedQuery = query.toLowerCase();
            
            return allStudentData.filter(student => {
                if (student.name === 'ë¯¸ë°°ì •') return false;
                
                return (
                    student.name.toLowerCase().includes(normalizedQuery) ||
                    student.roomNumber.toLowerCase().includes(normalizedQuery) ||
                    (student.studentInfo && student.studentInfo.librarySeats && 
                     student.studentInfo.librarySeats.toString().includes(normalizedQuery)) ||
                    (student.studentInfo && student.studentInfo.studentPhone && 
                     student.studentInfo.studentPhone.includes(normalizedQuery))
                );
            });
        }

        // ê°œë³„ í•™ìƒ ì¹´ë“œ í‘œì‹œ
        function showStudentCard(studentId) {
            const student = allStudentData.find(s => s.id === studentId);
            if (!student) return;

            document.getElementById('modal-title').textContent = `${student.name} ìƒì„¸ ì •ë³´`;
            document.getElementById('student-cards-container').innerHTML = createStudentCard(student);
            document.getElementById('student-detail-modal').classList.add('show');
            document.getElementById('search-results').style.display = 'none';
        }

        // ëª¨ë“  ë°ì´í„° ë¡œë“œ
        async function loadAllData() {
            try {
                // êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ëª¨ë“  í•™ìƒ ë°ì´í„° ë¡œë“œ
                allStudentData = await loadAllStudentsFromGoogleSheets();
                
                // ë³´ê³  ë°ì´í„° ë¡œë“œ
                reportData = await loadReportData();
                
                // í†µê³„ ê³„ì‚° ë° í‘œì‹œ
                calculateAndDisplayStats();
                displayBuildingReports();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ëª¨ë“  í•™ìƒ ë°ì´í„° ë¡œë“œ (ì‹œë®¬ë ˆì´ì…˜)
        async function loadAllStudentsFromGoogleSheets() {
            const students = [];
            let studentId = 1;

            Object.keys(dormitoryStructure).forEach(building => {
                dormitoryStructure[building].floors.forEach(floor => {
                    const floorStudents = generateFloorStudents(building, floor, studentId);
                    students.push(...floorStudents);
                    studentId += floorStudents.length;
                });
            });

            return students;
        }

        // ì¸µë³„ í•™ìƒ ë°ì´í„° ìƒì„± (ì‹œë®¬ë ˆì´ì…˜)
        function generateFloorStudents(building, floor, startId) {
            const students = [];
            const roomRanges = {
                A: { 1: [101, 160], 2: [201, 262], 3: [301, 362], 4: [401, 432] },
                B: { 1: [101, 140], 2: [201, 241], 3: [301, 341], 4: [401, 421] },
                C: { 1: [101, 161], 2: [201, 262], 3: [301, 362], 4: [401, 432] },
                D: { 1: [101, 144], 2: [201, 245], 3: [301, 345], 4: [401, 423] },
                E: { 1: [101, 176], 2: [201, 278], 3: [301, 378], 4: [401, 440] },
                F: { 1: [101, 132], 2: [201, 233], 3: [301, 333], 4: [401, 417] }
            };

            const [startRoom, endRoom] = roomRanges[building][floor];
            let currentId = startId;

            for (let roomNum = startRoom; roomNum <= endRoom; roomNum++) {
                const roomNumber = `${building}${roomNum}`; // 3ìë¦¬ í˜•ì‹: A101, B213 ë“±
                
                // 80% í™•ë¥ ë¡œ í•™ìƒ ë°°ì •
                if (Math.random() > 0.2) {
                    const isTripleRoom = floor === 4;
                    const studentCount = isTripleRoom ? Math.floor(Math.random() * 3) + 1 : 1;
                    
                    for (let i = 0; i < studentCount; i++) {
                        students.push({
                            id: `student_${currentId++}`,
                            roomNumber: roomNumber,
                            name: generateRandomName(),
                            status: getRandomStatus(),
                            memo: '',
                            gender: dormitoryStructure[building].gender,
                            building: building,
                            floor: floor,
                            studentInfo: generateStudentInfo(dormitoryStructure[building].gender)
                        });
                    }
                } else {
                    students.push({
                        id: `student_${currentId++}`,
                        roomNumber: roomNumber,
                        name: 'ë¯¸ë°°ì •',
                        status: 'ì •ìƒ',
                        memo: '',
                        gender: dormitoryStructure[building].gender,
                        building: building,
                        floor: floor,
                        studentInfo: null
                    });
                }
            }

            return students;
        }

        function generateRandomName() {
            const surnames = ['ê¹€', 'ì´', 'ë°•', 'ìµœ', 'ì •', 'ê°•', 'ì¡°', 'ìœ¤', 'ì¥', 'ì„', 'í•œ', 'ì˜¤', 'ì„œ', 'ì‹ '];
            const maleNames = ['ë¯¼ìˆ˜', 'ì² ìˆ˜', 'ì˜í˜¸', 'ë™í˜', 'ì„±ë¯¼', 'ì¤€í˜¸', 'í˜„ìš°', 'ì§€í›ˆ', 'íƒœí˜„', 'ìŠ¹ìš°'];
            const femaleNames = ['ì˜í¬', 'ìˆ˜ì§„', 'ì§€ì€', 'í•˜ëŠ˜', 'ë¯¼ì •', 'ì˜ˆì›', 'ì†Œì˜', 'ë‹¤í˜œ', 'ìœ ì§„', 'ì„œí˜„'];
            
            const surname = surnames[Math.floor(Math.random() * surnames.length)];
            const names = Math.random() > 0.5 ? maleNames : femaleNames;
            const name = names[Math.floor(Math.random() * names.length)];
            
            return surname + name;
        }

        function getRandomStatus() {
            const statuses = ['ì •ìƒ', 'ì •ìƒ', 'ì •ìƒ', 'ì •ìƒ', 'ì •ìƒ', 'ì™¸ë°•', 'ì‹ ê·œ', 'ë“±ë¯¸'];
            return statuses[Math.floor(Math.random() * statuses.length)];
        }

        function generateStudentInfo(gender) {
            const schools = ['ì„œìš¸ê³ ë“±í•™êµ', 'ë¶€ì‚°ê³ ë“±í•™êµ', 'ëŒ€êµ¬ê³ ë“±í•™êµ', 'ì¸ì²œê³ ë“±í•™êµ', 'ê´‘ì£¼ê³ ë“±í•™êµ'];
            const advisors = ['ê¹€ì˜í¬', 'ì´ì² ìˆ˜', 'ë°•ë¯¼ìˆ˜', 'ìµœìˆ˜ì§„', 'ì •ë™í˜'];
            
            return {
                parentPhone: `010-${Math.floor(Math.random() * 9000) + 1000}-${Math.floor(Math.random() * 9000) + 1000}`,
                studentPhone: `010-${Math.floor(Math.random() * 9000) + 1000}-${Math.floor(Math.random() * 9000) + 1000}`,
                librarySeats: Math.floor(Math.random() * 300) + 1,
                advisor: advisors[Math.floor(Math.random() * advisors.length)],
                birthDate: `200${Math.floor(Math.random() * 6) + 3}-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                gender: gender === 'male' ? 'ë‚¨' : 'ì—¬',
                admissionDate: '2024-03-01',
                school: schools[Math.floor(Math.random() * schools.length)],
                class: `${Math.floor(Math.random() * 3) + 1}í•™ë…„`
            };
        }

        // ë³´ê³  ë°ì´í„° ë¡œë“œ (ì‹œë®¬ë ˆì´ì…˜)
        async function loadReportData() {
            const reports = {};
            
            Object.keys(dormitoryStructure).forEach(building => {
                reports[building] = {};
                dormitoryStructure[building].floors.forEach(floor => {
                    reports[building][floor] = {
                        manager: getRandomManager(),
                        timestamp: new Date().toISOString(),
                        stats: calculateFloorStats(building, floor)
                    };
                });
            });
            
            return reports;
        }

        function getRandomManager() {
            const managers = ['ì´ì˜ìš´', 'ê¹€í˜œì •', 'ì´ì‹œìš°', 'ê³ ìŠ¹ì™„', 'ë‚¨ì¸ë‹¬', 'ì¡°ì˜ê¶Œ', 'í™©ë¯¼ì² ', 'ê¹€ê±´í¬', 'ê°•ì§€í›ˆ', 'ì†¡ì¸ìˆ˜'];
            return managers[Math.floor(Math.random() * managers.length)];
        }

        function calculateFloorStats(building, floor) {
            const floorStudents = allStudentData.filter(s => s.building === building && s.floor === floor && s.name !== 'ë¯¸ë°°ì •');
            
            const stats = {
                current: 0, overnight: 0, new: 0, checkout: 0,
                moveMinus: 0, movePlus: 0, late: 0, other: 0
            };

            floorStudents.forEach(student => {
                switch (student.status) {
                    case 'ì •ìƒ': case 'ì‹ ê·œ': case 'ì´ë™+': stats.current++; break;
                    case 'ì™¸ë°•': stats.overnight++; break;
                    case 'í‡´ì†Œ': stats.checkout++; break;
                    case 'ì‹ ê·œ': stats.new++; break;
                    case 'ì´ë™-': stats.moveMinus++; break;
                    case 'ì´ë™+': stats.movePlus++; break;
                    case 'ë“±ë¯¸': stats.late++; break;
                    default: stats.other++;
                }
            });

            return stats;
        }

        // í†µê³„ ê³„ì‚° ë° í‘œì‹œ
        function calculateAndDisplayStats() {
            const totalStats = {
                current: 0, overnight: 0, new: 0, checkout: 0,
                moveMinus: 0, movePlus: 0, late: 0, other: 0
            };

            const maleStats = {
                current: 0, overnight: 0, new: 0, checkout: 0,
                moveMinus: 0, movePlus: 0, late: 0, other: 0
            };

            const femaleStats = {
                current: 0, overnight: 0, new: 0, checkout: 0,
                moveMinus: 0, movePlus: 0, late: 0, other: 0
            };

            allStudentData.forEach(student => {
                if (student.name === 'ë¯¸ë°°ì •') return;

                const statType = getStatType(student.status);
                const statsObj = student.gender === 'male' ? maleStats : femaleStats;

                totalStats[statType]++;
                statsObj[statType]++;
            });

            // ì „ì²´ í†µê³„ í‘œì‹œ
            updateStatsDisplay('total', totalStats);
            updateStatsDisplay('male', maleStats);
            updateStatsDisplay('female', femaleStats);
        }

        function getStatType(status) {
            switch (status) {
                case 'ì •ìƒ': case 'ì‹ ê·œ': case 'ì´ë™+': return 'current';
                case 'ì™¸ë°•': return 'overnight';
                case 'í‡´ì†Œ': return 'checkout';
                case 'ì‹ ê·œ': return 'new';
                case 'ì´ë™-': return 'moveMinus';
                case 'ì´ë™+': return 'movePlus';
                case 'ë“±ë¯¸': return 'late';
                default: return 'other';
            }
        }

        function updateStatsDisplay(prefix, stats) {
            Object.keys(stats).forEach(key => {
                const element = document.getElementById(`${prefix}-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
                if (element) {
                    element.textContent = stats[key];
                }
            });
        }

        // ë™ë³„ ë³´ê³  í˜„í™© í‘œì‹œ
        function displayBuildingReports() {
            const container = document.getElementById('building-reports');
            container.innerHTML = '';

            Object.keys(dormitoryStructure).forEach(building => {
                const buildingCard = document.createElement('div');
                buildingCard.className = 'building-card';
                
                const genderText = dormitoryStructure[building].gender === 'male' ? 'ë‚¨í•™ìƒ' : 'ì—¬í•™ìƒ';
                
                buildingCard.innerHTML = `
                    <div class="building-header">
                        <div class="building-name">${building}ë™ (${genderText})</div>
                    </div>
                    <div class="floor-reports">
                        ${dormitoryStructure[building].floors.map(floor => `
                            <div class="floor-card">
                                <div class="floor-info">
                                    <div class="floor-name">${floor}ì¸µ ${floor === 4 ? '(3ì¸ì‹¤)' : '(1ì¸ì‹¤)'}</div>
                                    <div class="manager-name">ë‹´ë‹¹: ${reportData[building] && reportData[building][floor] ? reportData[building][floor].manager : 'ë¯¸ì§€ì •'}</div>
                                </div>
                                <div class="floor-stats">
                                    ${generateFloorStatElements(building, floor)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(buildingCard);
            });
        }

        function generateFloorStatElements(building, floor) {
            if (!reportData[building] || !reportData[building][floor]) {
                return '<div class="floor-stat">ë°ì´í„° ì—†ìŒ</div>';
            }

            const stats = reportData[building][floor].stats;
            return Object.entries(stats)
                .filter(([key, value]) => value > 0)
                .map(([key, value]) => `
                    <div class="floor-stat" onclick="showBuildingFloorStudents('${building}', ${floor}, '${key}')">
                        ${getStatDisplayName(key)}: ${value}
                    </div>
                `).join('');
        }

        function getStatDisplayName(key) {
            const names = {
                current: 'í˜„ì¬ì›',
                overnight: 'ì™¸ë°•',
                new: 'ì‹ ê·œ',
                checkout: 'í‡´ì†Œ',
                moveMinus: 'ì´ë™-',
                movePlus: 'ì´ë™+',
                late: 'ë“±ë¯¸',
                other: 'ê¸°íƒ€'
            };
            return names[key] || key;
        }

        // í•™ìƒ ìƒì„¸ ì •ë³´ í‘œì‹œ
        function showStudentDetails(category, type) {
            let filteredStudents = [];
            let title = '';

            if (category === 'total') {
                filteredStudents = allStudentData.filter(s => s.name !== 'ë¯¸ë°°ì •' && getStatType(s.status) === type);
                title = `ì „ì²´ ${getStatDisplayName(type)} í•™ìƒ`;
            } else if (category === 'male') {
                filteredStudents = allStudentData.filter(s => s.name !== 'ë¯¸ë°°ì •' && s.gender === 'male' && getStatType(s.status) === type);
                title = `ë‚¨í•™ìƒ ${getStatDisplayName(type)} í•™ìƒ`;
            } else if (category === 'female') {
                filteredStudents = allStudentData.filter(s => s.name !== 'ë¯¸ë°°ì •' && s.gender === 'female' && getStatType(s.status) === type);
                title = `ì—¬í•™ìƒ ${getStatDisplayName(type)} í•™ìƒ`;
            }

            showStudentModal(title, filteredStudents);
        }

        function showBuildingFloorStudents(building, floor, statType) {
            const filteredStudents = allStudentData.filter(s => 
                s.building === building && 
                s.floor === floor && 
                s.name !== 'ë¯¸ë°°ì •' && 
                getStatType(s.status) === statType
            );

            const title = `${building}ë™ ${floor}ì¸µ ${getStatDisplayName(statType)} í•™ìƒ`;
            showStudentModal(title, filteredStudents);
        }

        function showStudentModal(title, students) {
            document.getElementById('modal-title').textContent = `${title} (${students.length}ëª…)`;
            
            const container = document.getElementById('student-cards-container');
            if (students.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #94a3b8;">í•´ë‹¹í•˜ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                container.innerHTML = students.map(student => createStudentCard(student)).join('');
            }
            
            document.getElementById('student-detail-modal').classList.add('show');
        }

        function createStudentCard(student) {
            if (!student.studentInfo) {
                return `
                    <div class="student-info-card">
                        <div class="student-card-header">
                            <div class="student-room">${student.roomNumber}</div>
                            <div class="student-status status-normal">ë¯¸ë°°ì •</div>
                        </div>
                        <div class="student-details">
                            <div class="detail-row">
                                <span class="detail-label">ìƒíƒœ</span>
                                <span class="detail-value">ë¯¸ë°°ì •</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="student-info-card">
                    <div class="student-card-header">
                        <div class="student-room">${student.roomNumber}</div>
                        <div class="student-status ${getStatusClass(student.status)}">${student.status}</div>
                    </div>
                    <div class="student-details">
                        <div class="detail-row">
                            <span class="detail-label">ì´ë¦„</span>
                            <span class="detail-value">${student.name}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ì„±ë³„</span>
                            <span class="detail-value">${student.studentInfo.gender}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">í•™ë¶€ëª¨ ì—°ë½ì²˜</span>
                            <span class="detail-value">${student.studentInfo.parentPhone}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ë³¸ì¸ ì—°ë½ì²˜</span>
                            <span class="detail-value">${student.studentInfo.studentPhone}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¢Œì„</span>
                            <span class="detail-value">${student.studentInfo.librarySeats}ë²ˆ</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ìƒí™œë‹´ì„</span>
                            <span class="detail-value">${student.studentInfo.advisor}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ìƒë…„ì›”ì¼</span>
                            <span class="detail-value">${student.studentInfo.birthDate}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ì…ì†Œì¼</span>
                            <span class="detail-value">${student.studentInfo.admissionDate}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ì¶œì‹ ê³ êµ</span>
                            <span class="detail-value">${student.studentInfo.school}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ë°˜</span>
                            <span class="detail-value">${student.studentInfo.class}</span>
                        </div>
                        ${student.memo ? `
                        <div class="detail-row">
                            <span class="detail-label">ë¹„ê³ </span>
                            <span class="detail-value">${student.memo}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            const statusMap = {
                'ì •ìƒ': 'status-normal',
                'ì™¸ë°•': 'status-overnight',
                'í‡´ì†Œ': 'status-checkout',
                'ì‹ ê·œ': 'status-new',
                'ì´ë™-': 'status-move-minus',
                'ì´ë™+': 'status-move-plus',
                'ë“±ë¯¸': 'status-late'
            };
            return statusMap[status] || 'status-normal';
        }

        function closeModal() {
            document.getElementById('student-detail-modal').classList.remove('show');
        }

        async function refreshAllData() {
            const refreshBtn = document.querySelector('.refresh-btn');
            const icon = refreshBtn.querySelector('i');
            
            // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            icon.style.animation = 'spin 1s linear infinite';
            
            try {
                await loadAllData();
                
                // ì„±ê³µ í”¼ë“œë°±
                refreshBtn.style.background = 'linear-gradient(45deg, #10b981, #059669)';
                setTimeout(() => {
                    refreshBtn.style.background = 'linear-gradient(45deg, #10b981, #059669)';
                }, 2000);
                
            } catch (error) {
                console.error('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
                
                // ì˜¤ë¥˜ í”¼ë“œë°±
                refreshBtn.style.background = 'linear-gradient(45deg, #ef4444, #dc2626)';
                setTimeout(() => {
                    refreshBtn.style.background = 'linear-gradient(45deg, #10b981, #059669)';
                }, 2000);
            } finally {
                // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ
                icon.style.animation = '';
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('student-detail-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                document.getElementById('search-results').style.display = 'none';
            }
        });

        // ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ (30ì´ˆë§ˆë‹¤)
        setInterval(() => {
            refreshAllData();
        }, 30000);

        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                refreshAllData();
            }
        });
    </script>
</body>
</html>
